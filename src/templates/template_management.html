{% extends "base.html" %}

{% block title %}Email Templates - Inbox Genie{% endblock %}

{% block extra_css %}
<style>
    .template-editor {
        height: 350px;
        font-family: monospace;
        white-space: pre;
    }
    .template-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        height: 100%;
    }
    .template-card:hover {
        transform: translateY(-5px);
    }
    .template-variables {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    .variable-badge {
        background-color: #e9ecef;
        border-radius: 4px;
        padding: 2px 8px;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .variable-badge:hover {
        background-color: #dee2e6;
    }
    .template-preview {
        background-color: #f8f9fa;
        border-left: 4px solid #6f42c1;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: 'Arial', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5">
        <div class="col-lg-12 text-center">
            <h1>Email Template Management</h1>
            <p class="lead">Customize your email templates to match your brand voice and outreach strategy</p>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle-fill me-2"></i>Template Variables</h5>
                <p>Use these variables in your templates to dynamically insert recipient information:</p>
                <div>
                    <span class="variable-badge" data-variable="{{name}}">{{name}}</span>
                    <span class="variable-badge" data-variable="{{role}}">{{role}}</span>
                    <span class="variable-badge" data-variable="{{company}}">{{company}}</span>
                    <span class="variable-badge" data-variable="{{industry}}">{{industry}}</span>
                    <span class="variable-badge" data-variable="{{recent_activity}}">{{recent_activity}}</span>
                    <span class="variable-badge" data-variable="{{industry_news}}">{{industry_news}}</span>
                    <span class="variable-badge" data-variable="{{pain_points}}">{{pain_points}}</span>
                </div>
                <p class="mt-3 mb-0">You can also use these variables for your information:</p>
                <div>
                    <span class="variable-badge" data-variable="{{username}}">{{username}}</span>
                    <span class="variable-badge" data-variable="{{position}}">{{position}}</span>
                    <span class="variable-badge" data-variable="{{contact_info}}">{{contact_info}}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-lg-12">
            <ul class="nav nav-tabs" id="templateTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cold-email-tab" data-bs-toggle="tab" data-bs-target="#cold-email" type="button" role="tab" aria-controls="cold-email" aria-selected="true">
                        Cold Email
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="follow-up-tab" data-bs-toggle="tab" data-bs-target="#follow-up" type="button" role="tab" aria-controls="follow-up" aria-selected="false">
                        Follow Up
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="meeting-request-tab" data-bs-toggle="tab" data-bs-target="#meeting-request" type="button" role="tab" aria-controls="meeting-request" aria-selected="false">
                        Meeting Request
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="my-templates-tab" data-bs-toggle="tab" data-bs-target="#my-templates" type="button" role="tab" aria-controls="my-templates" aria-selected="false">
                        <i class="bi bi-collection me-1"></i> My Templates
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="custom-template-tab" data-bs-toggle="tab" data-bs-target="#custom-template" type="button" role="tab" aria-controls="custom-template" aria-selected="false">
                        <i class="bi bi-plus-circle me-1"></i> Create New
                    </button>
                </li>
            </ul>
            
            <div class="tab-content p-4 border border-top-0 rounded-bottom" id="templateTabsContent">
                <!-- Cold Email Template -->
                <div class="tab-pane fade show active" id="cold-email" role="tabpanel" aria-labelledby="cold-email-tab">
                    <div class="row">
                        <div class="col-lg-7">
                            <h4 class="mb-3">Cold Email Template</h4>
                            <p>This template is used for initial outreach to new prospects.</p>
                            
                            <form id="coldEmailForm">
                                <div class="mb-3">
                                    <label for="coldEmailEditor" class="form-label">Template Content</label>
                                    <textarea class="form-control template-editor" id="coldEmailEditor" name="template_content">{{ templates.cold_email }}</textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary reset-btn" data-template-type="cold_email">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Default
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Save Template
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-5">
                            <h4 class="mb-3">Template Preview</h4>
                            <p>Here's how your email will look with sample data:</p>
                            
                            <div class="template-preview" id="coldEmailPreview"></div>
                            
                            <div class="mt-4">
                                <h5>Best Practices</h5>
                                <ul>
                                    <li>Keep your opening personalized based on research</li>
                                    <li>Clearly explain the value proposition</li>
                                    <li>Address common pain points in their industry</li>
                                    <li>Include a clear, specific call-to-action</li>
                                    <li>Keep the email under 200 words</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Follow Up Template -->
                <div class="tab-pane fade" id="follow-up" role="tabpanel" aria-labelledby="follow-up-tab">
                    <div class="row">
                        <div class="col-lg-7">
                            <h4 class="mb-3">Follow Up Template</h4>
                            <p>This template is used for following up with prospects who haven't responded.</p>
                            
                            <form id="followUpForm">
                                <div class="mb-3">
                                    <label for="followUpEditor" class="form-label">Template Content</label>
                                    <textarea class="form-control template-editor" id="followUpEditor" name="template_content">{{ templates.follow_up }}</textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary reset-btn" data-template-type="follow_up">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Default
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Save Template
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-5">
                            <h4 class="mb-3">Template Preview</h4>
                            <p>Here's how your email will look with sample data:</p>
                            
                            <div class="template-preview" id="followUpPreview"></div>
                            
                            <div class="mt-4">
                                <h5>Best Practices</h5>
                                <ul>
                                    <li>Reference your previous email</li>
                                    <li>Provide additional value or information</li>
                                    <li>Keep it shorter than the original email</li>
                                    <li>Include a clear, low-friction next step</li>
                                    <li>Make it easy to respond with a simple question</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Meeting Request Template -->
                <div class="tab-pane fade" id="meeting-request" role="tabpanel" aria-labelledby="meeting-request-tab">
                    <div class="row">
                        <div class="col-lg-7">
                            <h4 class="mb-3">Meeting Request Template</h4>
                            <p>This template is used specifically for requesting meetings or calls.</p>
                            
                            <form id="meetingRequestForm">
                                <div class="mb-3">
                                    <label for="meetingRequestEditor" class="form-label">Template Content</label>
                                    <textarea class="form-control template-editor" id="meetingRequestEditor" name="template_content">{{ templates.meeting_request }}</textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary reset-btn" data-template-type="meeting_request">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Default
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Save Template
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-5">
                            <h4 class="mb-3">Template Preview</h4>
                            <p>Here's how your email will look with sample data:</p>
                            
                            <div class="template-preview" id="meetingRequestPreview"></div>
                            
                            <div class="mt-4">
                                <h5>Best Practices</h5>
                                <ul>
                                    <li>Be specific about the meeting purpose</li>
                                    <li>Suggest specific times (provide options)</li>
                                    <li>Keep it brief and focused</li>
                                    <li>Explain what they'll gain from the meeting</li>
                                    <li>Make it easy to schedule (suggest a scheduling link)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Templates -->
                <div class="tab-pane fade" id="my-templates" role="tabpanel" aria-labelledby="my-templates-tab">
                    <div class="row">
                        <div class="col-lg-12">
                            <h4 class="mb-3">My Templates</h4>
                            <p>Here are your saved custom templates:</p>
                            
                            {% if custom_templates and custom_templates|length > 0 %}
                                <div class="row" id="templates-container">
                                    {% for template in custom_templates %}
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card template-card h-100">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">{{ template.name }}</h5>
                                            </div>
                                            <div class="card-body">
                                                {% if template.description %}
                                                <p class="card-text">{{ template.description }}</p>
                                                {% else %}
                                                <p class="card-text text-muted">No description provided.</p>
                                                {% endif %}
                                                <div class="d-flex align-items-center mt-3">
                                                    <span class="badge bg-primary me-2">Custom</span>
                                                    <small class="text-muted">Created: {{ template.created_at.strftime('%b %d, %Y') }}</small>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white">
                                                <div class="d-flex justify-content-between">
                                                    <button type="button" class="btn btn-sm btn-outline-primary view-template-btn" data-template-id="{{ template.id }}">
                                                        <i class="bi bi-eye me-1"></i>View
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-template-btn" data-template-id="{{ template.id }}" data-template-name="{{ template.name }}">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>You haven't created any custom templates yet. 
                                    <a href="#" class="alert-link" onclick="document.getElementById('custom-template-tab').click(); return false;">Create your first template</a>.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Template View Modal -->
                    <div class="modal fade" id="viewTemplateModal" tabindex="-1" aria-labelledby="viewTemplateModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewTemplateModalLabel">View Template</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="template-content-preview p-3 bg-light rounded" style="white-space: pre-wrap;"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary edit-template-btn">
                                        <i class="bi bi-pencil me-1"></i>Edit This Template
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delete Confirmation Modal -->
                    <div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteTemplateModalLabel">Confirm Deletion</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete the template "<span id="templateToDelete"></span>"?</p>
                                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger confirm-delete-btn">Delete Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Template -->
                <div class="tab-pane fade" id="custom-template" role="tabpanel" aria-labelledby="custom-template-tab">
                    <div class="row">
                        <div class="col-lg-7">
                            <h4 class="mb-3">Custom Template</h4>
                            <p>Create a custom template for your specific needs.</p>
                            
                            <form id="customTemplateForm">
                                <div class="mb-3">
                                    <label for="customTemplateName" class="form-label">Template Name</label>
                                    <input type="text" class="form-control" id="customTemplateName" name="template_name">
                                </div>
                                <div class="mb-3">
                                    <label for="customTemplateEditor" class="form-label">Template Content</label>
                                    <textarea class="form-control template-editor" id="customTemplateEditor" name="template_content"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Save Template
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-5">
                            <h4 class="mb-3">Template Preview</h4>
                            <p>Here's how your email will look with sample data:</p>
                            
                            <div class="template-preview" id="customTemplatePreview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const variableBadges = document.querySelectorAll('.variable-badge');
    const coldEmailEditor = document.getElementById('coldEmailEditor');
    const followUpEditor = document.getElementById('followUpEditor');
    const meetingRequestEditor = document.getElementById('meetingRequestEditor');
    const customTemplateEditor = document.getElementById('customTemplateEditor');
    const coldEmailPreview = document.getElementById('coldEmailPreview');
    const followUpPreview = document.getElementById('followUpPreview');
    const meetingRequestPreview = document.getElementById('meetingRequestPreview');
    const customTemplatePreview = document.getElementById('customTemplatePreview');
    const resetButtons = document.querySelectorAll('.reset-btn');
    
    // Default templates (for reset functionality)
    const defaultTemplates = {
        cold_email: `{{ templates.cold_email|replace("\\", "\\\\")|replace("'", "\\'")|replace('\n', '\\n')|safe }}`,
        follow_up: `{{ templates.follow_up|replace("\\", "\\\\")|replace("'", "\\'")|replace('\n', '\\n')|safe }}`,
        meeting_request: `{{ templates.meeting_request|replace("\\", "\\\\")|replace("'", "\\'")|replace('\n', '\\n')|safe }}`
    };
    
    // Initialize template editors with content
    if (coldEmailEditor) coldEmailEditor.value = defaultTemplates.cold_email;
    if (followUpEditor) followUpEditor.value = defaultTemplates.follow_up;
    if (meetingRequestEditor) meetingRequestEditor.value = defaultTemplates.meeting_request;
    
    // Sample data for template preview
    const sampleData = {
        name: 'John Smith',
        role: 'CTO',
        company: 'Acme Technologies',
        industry: 'Software Development',
        recent_activity: 'your recent talk at TechConf 2025',
        industry_news: 'your company\'s new AI initiative',
        pain_points: 'scaling your engineering team while maintaining quality'
    };
    
    // Function to replace template variables with sample data
    function replaceVariables(template, data) {
        let result = template;
        for (const [key, value] of Object.entries(data)) {
            // Create a regular expression to replace all instances of {{key}}
            const pattern = new RegExp('\\{\\{' + key + '\\}\\}', 'g');
            result = result.replace(pattern, value);
        }
        return result;
    }
    
    // Update all preview areas with generated email content
    function updatePreviews() {
        if (coldEmailEditor) coldEmailPreview.innerText = replaceVariables(coldEmailEditor.value, sampleData);
        if (followUpEditor) followUpPreview.innerText = replaceVariables(followUpEditor.value, sampleData);
        if (meetingRequestEditor) meetingRequestPreview.innerText = replaceVariables(meetingRequestEditor.value, sampleData);
        if (customTemplateEditor) customTemplatePreview.innerText = replaceVariables(customTemplateEditor.value, sampleData);
    }
    
    // Add variable to editor when badge is clicked
    variableBadges.forEach(badge => {
        badge.addEventListener('click', function() {
            const variable = this.getAttribute('data-variable');
            const variableText = '{{' + variable + '}}';
            
            // Find active editor
            let activeEditor = null;
            
            if (document.activeElement === coldEmailEditor) {
                activeEditor = coldEmailEditor;
            } else if (document.activeElement === followUpEditor) {
                activeEditor = followUpEditor;
            } else if (document.activeElement === meetingRequestEditor) {
                activeEditor = meetingRequestEditor;
            } else if (document.activeElement === customTemplateEditor) {
                activeEditor = customTemplateEditor;
            } else {
                // Default to the visible tab's editor
                if (document.getElementById('cold-email').classList.contains('active')) {
                    activeEditor = coldEmailEditor;
                } else if (document.getElementById('follow-up').classList.contains('active')) {
                    activeEditor = followUpEditor;
                } else if (document.getElementById('meeting-request').classList.contains('active')) {
                    activeEditor = meetingRequestEditor;
                } else if (document.getElementById('custom-template').classList.contains('active')) {
                    activeEditor = customTemplateEditor;
                }
            }
            
            if (activeEditor) {
                // Insert at cursor position
                const startPos = activeEditor.selectionStart;
                const endPos = activeEditor.selectionEnd;
                activeEditor.value = activeEditor.value.substring(0, startPos) 
                    + variableText 
                    + activeEditor.value.substring(endPos, activeEditor.value.length);
                
                // Update preview
                updatePreviews();
                
                // Set focus back to editor and place cursor after inserted variable
                activeEditor.focus();
                activeEditor.selectionStart = startPos + variableText.length;
                activeEditor.selectionEnd = startPos + variableText.length;
            }
        });
    });
    
    // Update preview when editors change
    if (coldEmailEditor) coldEmailEditor.addEventListener('input', updatePreviews);
    if (followUpEditor) followUpEditor.addEventListener('input', updatePreviews);
    if (meetingRequestEditor) meetingRequestEditor.addEventListener('input', updatePreviews);
    if (customTemplateEditor) customTemplateEditor.addEventListener('input', updatePreviews);
    
    // Reset templates to default when reset button is clicked
    resetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateType = this.getAttribute('data-template-type');
            let editor = null;
            
            if (templateType === 'cold_email') {
                editor = coldEmailEditor;
                editor.value = defaultTemplates.cold_email;
            } else if (templateType === 'follow_up') {
                editor = followUpEditor;
                editor.value = defaultTemplates.follow_up;
            } else if (templateType === 'meeting_request') {
                editor = meetingRequestEditor;
                editor.value = defaultTemplates.meeting_request;
            }
            
            updatePreviews();
        });
    });
    
    // Save standard template changes
    function saveTemplate(templateType, templateContent) {
        fetch('/save-template', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                template_type: templateType,
                template_content: templateContent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification
                const toastHTML = 
                '<div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">' +
                    '<div class="d-flex">' +
                        '<div class="toast-body">' +
                            '<i class="bi bi-check-circle me-2"></i>' + data.message +
                        '</div>' +
                        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
                    '</div>' +
                '</div>';
                
                const toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.innerHTML = toastHTML;
                document.body.appendChild(toastContainer);
                
                const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
                toast.show();
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    toast.hide();
                    setTimeout(() => {
                        document.body.removeChild(toastContainer);
                    }, 500);
                }, 3000);
            } else {
                alert('Error saving template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error saving template:', error);
            alert('There was an error saving your template. Please try again.');
        });
    }
    
    // Save custom template
    function saveCustomTemplate(templateContent, templateName) {
        fetch('/save-custom-template', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                template_name: templateName,
                template_content: templateContent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification
                const toastHTML = 
                '<div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">' +
                    '<div class="d-flex">' +
                        '<div class="toast-body">' +
                            '<i class="bi bi-check-circle me-2"></i>' + data.message +
                        '</div>' +
                        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
                    '</div>' +
                '</div>';
                
                const toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.innerHTML = toastHTML;
                document.body.appendChild(toastContainer);
                
                const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
                toast.show();
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    toast.hide();
                    setTimeout(() => {
                        document.body.removeChild(toastContainer);
                    }, 500);
                }, 3000);
                
                // Reset the form
                document.getElementById('customTemplateName').value = '';
                document.getElementById('customTemplateEditor').value = '';
                customTemplatePreview.innerText = '';
                
                // Refresh the page to show the new template
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                alert('Error saving template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error saving custom template:', error);
            alert('There was an error saving your template. Please try again.');
        });
    }
    
    // Handle form submissions
    document.getElementById('coldEmailForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveTemplate('cold_email', coldEmailEditor.value);
    });
    
    document.getElementById('followUpForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveTemplate('follow_up', followUpEditor.value);
    });
    
    document.getElementById('meetingRequestForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveTemplate('meeting_request', meetingRequestEditor.value);
    });
    
    document.getElementById('customTemplateForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const templateName = document.getElementById('customTemplateName').value;
        const templateContent = customTemplateEditor.value;
        
        if (!templateName) {
            alert('Please enter a template name');
            return;
        }
        
        if (!templateContent) {
            alert('Please enter template content');
            return;
        }
        
        saveCustomTemplate(templateContent, templateName);
    });
    
    // Handle template view buttons
    const viewButtons = document.querySelectorAll('.view-template-btn');
    const viewModal = new bootstrap.Modal(document.getElementById('viewTemplateModal'));
    const templateContentPreview = document.querySelector('.template-content-preview');
    const editTemplateBtn = document.querySelector('.edit-template-btn');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-template-id');
            
            // Fetch template content from API
            fetch(`/api/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.template) {
                        // Show content in modal
                        templateContentPreview.innerText = data.template.content;
                        
                        // Set up edit button
                        editTemplateBtn.setAttribute('data-template-id', templateId);
                        
                        // Show modal
                        viewModal.show();
                    } else {
                        alert('Error loading template. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching template:', error);
                    alert('Error loading template. Please try again.');
                });
        });
    });
    
    // Handle edit button in view modal
    editTemplateBtn?.addEventListener('click', function() {
        const templateId = this.getAttribute('data-template-id');
        
        // Close view modal
        viewModal.hide();
        
        // Load template into custom editor
        fetch(`/api/templates/${templateId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.template) {
                    // Switch to custom template tab
                    document.getElementById('custom-template-tab').click();
                    
                    // Populate form
                    document.getElementById('customTemplateName').value = data.template.name;
                    document.getElementById('customTemplateEditor').value = data.template.content;
                    
                    // Update preview
                    updatePreviews();
                } else {
                    alert('Error loading template for editing. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error fetching template for edit:', error);
                alert('Error loading template for editing. Please try again.');
            });
    });
    
    // Handle delete template buttons
    const deleteButtons = document.querySelectorAll('.delete-template-btn');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteTemplateModal'));
    const templateToDeleteSpan = document.getElementById('templateToDelete');
    const confirmDeleteBtn = document.querySelector('.confirm-delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-template-id');
            const templateName = this.getAttribute('data-template-name');
            
            // Set up confirmation modal
            templateToDeleteSpan.innerText = templateName;
            confirmDeleteBtn.setAttribute('data-template-id', templateId);
            
            // Show modal
            deleteModal.show();
        });
    });
    
    // Handle delete confirmation
    confirmDeleteBtn?.addEventListener('click', function() {
        const templateId = this.getAttribute('data-template-id');
        
        // Call API to delete template
        fetch(`/delete-template/${templateId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                // Hide modal
                deleteModal.hide();
                
                if (data.success) {
                    // Show success message
                    alert(data.message);
                    
                    // Refresh page to update templates list
                    window.location.reload();
                } else {
                    alert('Error deleting template: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting template:', error);
                alert('Error deleting template. Please try again.');
                
                // Hide modal
                deleteModal.hide();
            });
    });
    
    // Initialize previews
    updatePreviews();
});
</script>
{% endblock %}
